<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoathBet Dashboard</title>

<script>
    (function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        if (isLoggedIn !== 'true') {
            // Redireciona para o caminho raiz (que carrega o index.html)
            window.location.replace('/'); 
        }
    })();
</script>
    <style>
        /* Variáveis de Cores - AJUSTADAS PARA FUNDO PRETO, MANTENDO AZUL, ROXO E ROSA */
        :root {
            --cor-fundo-principal: #0a0a0a; /* Fundo Preto */
            --cor-fundo-sidebar: #111111; 
            --cor-texto-claro: #ffffff;
            --cor-texto-suave: #a9a9b3;
            --cor-destaque-roxo: #6a0dad; /* Roxo Original MANTIDO */
            --cor-destaque-rosa: #ff1493; /* Rosa Original MANTIDO */
            --cor-destaque-azul: #00bfff; /* Azul Original MANTIDO (para velas/filtros) */
            --cor-card-fundo: #1e1e1e; /* Cards em Preto Escuro */
            --cor-verde: #50c878; 
            --cor-vermelho: #ff5252; 
        }

        /* Estilos Globais */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: var(--cor-fundo-principal); /* Fundo Preto */
            color: var(--cor-texto-claro);
            display: flex;
            height: 100vh;
            overflow: hidden; 
        }

        /* Layout Principal */
        .dashboard-container {
            display: flex; 
            width: 100%;
        }
        /* SIDEBAR REMOVIDA */
        .sidebar {
            display: none; 
        }

        /* Conteúdo Principal */
        .main-content {
            padding: 20px 30px;
            overflow-y: auto; 
            width: 100%; 
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* Estilo do Input de Data */
        .date-filter-input {
            background-color: var(--cor-card-fundo);
            color: var(--cor-texto-claro);
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
        }

        .user-profile {
            /* MUDANÇA APLICADA AQUI: AZUL MARINHO */
            background-color: #001f3f; /* Azul Marinho/Escuro */
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
        }

        /* Cards de Estatísticas */
        .stats-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .card {
            background-color: var(--cor-card-fundo); 
            padding: 15px 20px;
            border-radius: 8px;
            flex: 1;
            min-width: 150px;
            max-width: 250px;
        }

        .card-label {
            color: var(--cor-texto-suave);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 1.4em;
            font-weight: bold;
        }

        /* Cores Fixas (Médias) - ORIGINAIS MANTIDAS */
        .card-value.blue { color: var(--cor-destaque-azul); }
        .card-value.purple { color: var(--cor-destaque-roxo); }
        .card-value.pink { color: var(--cor-destaque-rosa); }

        /* Filtro de Cores */
        .color-filter {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-label {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--cor-texto-suave);
        }

        .filter-checkbox-group {
            display: flex;
            gap: 15px;
        }

        .filter-checkbox {
            display: none;
        }

        .filter-button {
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            font-weight: bold;
            transition: background-color 0.2s, border-color 0.2s;
        }

        /* Estilos dos Botões de Filtro - ORIGINAIS MANTIDOS */
        #filter-blue:checked + .filter-button { background-color: var(--cor-destaque-azul); border-color: var(--cor-destaque-azul); color: var(--cor-fundo-principal); }
        #filter-blue:not(:checked) + .filter-button { background-color: transparent; border-color: var(--cor-destaque-azul); color: var(--cor-destaque-azul); }

        #filter-purple:checked + .filter-button { background-color: var(--cor-destaque-roxo); border-color: var(--cor-destaque-roxo); color: var(--cor-fundo-principal); }
        #filter-purple:not(:checked) + .filter-button { background-color: transparent; border-color: var(--cor-destaque-roxo); color: var(--cor-destaque-roxo); }

        #filter-pink:checked + .filter-button { background-color: var(--cor-destaque-rosa); border-color: var(--cor-destaque-rosa); color: var(--cor-fundo-principal); }
        #filter-pink:not(:checked) + .filter-button { background-color: transparent; border-color: var(--cor-destaque-rosa); color: var(--cor-destaque-rosa); }


        /* Grid de Multiplicadores (Velas) */
        .multiplier-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); 
            gap: 10px;
            align-items: start; 
        }

        .multiplier-cell {
            width: 100%; 
            padding: 15px 5px;
            border-radius: 8px;
            text-align: center;
            height: 80px; 
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            transition: opacity 0.3s, transform 0.3s;
        }

        .multiplier-cell.hidden {
            display: none;
        }
        
        .multiplier-value {
            font-size: 1.1em;
            font-weight: bold;
            line-height: 1.2;
        }

        .multiplier-time {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Cores das Células - ORIGINAIS MANTIDAS */
        .color-blue { background-color: var(--cor-destaque-azul); }
        .color-purple { background-color: var(--cor-destaque-roxo); }
        .color-pink { background-color: var(--cor-destaque-rosa); }

    </style>
</head>
<body>

    <div class="dashboard-container" id="dashboard-container">
        <div class="sidebar">
            </div>

        <div class="main-content">
            <div class="header">
                <h2>Dashboard</h2>
                <input type="date" id="date-filter" class="date-filter-input" onchange="renderDashboard()">
                <div class="user-profile">goathbet</div>
            </div>

            <div class="stats-cards">
                <div class="card">
                    <div class="card-label">Média azul</div>
                    <div class="card-value blue">1.10x</div>
                </div>
                <div class="card">
                    <div class="card-label">Média Roxa</div>
                    <div class="card-value purple">2.00x</div>
                </div>
                <div class="card">
                    <div class="card-label">Média Rosa</div>
                    <div class="card-value pink">10.00x</div>
                </div>
            </div>

            <div class="color-filter">
                <div class="filter-label">Filtrar Cores:</div>
                <div class="filter-checkbox-group">
                    <input type="checkbox" id="filter-blue" class="filter-checkbox" checked onchange="renderDashboard()">
                    <label for="filter-blue" class="filter-button">Azul</label>

                    <input type="checkbox" id="filter-purple" class="filter-checkbox" checked onchange="renderDashboard()">
                    <label for="filter-purple" class="filter-button">Roxo</label>

                    <input type="checkbox" id="filter-pink" class="filter-checkbox" checked onchange="renderDashboard()">
                    <label for="filter-pink" class="filter-button">Rosa</label>
                </div>
            </div>

            <h3>Gráfico Atual em tempo real</h3>

            <div class="multiplier-grid" id="multiplier-grid">
                <div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: var(--cor-texto-suave);">Aguardando dados do bot...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // ====================================================================
        // 1. IMPORTS E CONFIGURAÇÃO FIREBASE
        // ====================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        // Config Firebase (Apenas Leitura)
        const firebaseConfig = {
          apiKey: "AIzaSyB-35zQDrQbz8ohT_o_u_d_q_p_F_k_a_y_Y_d_A_U_D_r_L_w_6_g", // Chave fictícia por segurança
          authDomain: "history-dashboard-a70ee.firebaseapp.com",
          databaseURL: "https://history-dashboard-a70ee-default-rtdb.firebaseio.com",
          projectId: "history-dashboard-a70ee",
          storageBucket: "history-dashboard-a70ee.firebasestorage.app",
          messagingSenderId: "969153856969",
          appId: "1:969153856969:web:6b50fae1db463b8352d418",
          measurementId: "G-9MVGBX2KLX"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Variáveis Globais (Dados e UI)
        let historyData = []; 
        const multiplierGrid = document.getElementById('multiplier-grid');
        const dateFilter = document.getElementById('date-filter');
        
        // ====================================================================
        // 2. FUNÇÕES AUXILIARES
        // ====================================================================

        function getVelaColor(nValue) {
            if (nValue >= 10.00) {
                return 'pink'; 
            } else if (nValue >= 2.00) {
                return 'purple'; 
            } else {
                return 'blue'; 
            }
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) {
                const [h, m, s] = parts;
                return h * 60 + m + s / 60;
            }
            return 0;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // ====================================================================
        // 3. LÓGICA DE CÁLCULO DE MÉDIAS (Piso Mínimo)
        // ====================================================================

        function calculateColorAverages(history) {
            const limitedHistory = history.slice(0, 5000); 

            const lastBlue = limitedHistory.find(item => item.color === 'blue');
            const lastPurple = limitedHistory.find(item => item.color === 'purple');
            const lastPink = limitedHistory.find(item => item.color === 'pink');

            const blueValue = lastBlue ? Math.max(lastBlue.multiplier / 1.15, 1.10) : 1.10;
            const purpleValue = lastPurple ? Math.max(lastPurple.multiplier / 1.15, 2.00) : 2.00;
            const pinkValue = lastPink ? Math.max(lastPink.multiplier / 1.7, 10.00) : 10.00;

            document.querySelector('.card-value.blue').textContent = `${blueValue.toFixed(2)}x`;
            document.querySelector('.card-value.purple').textContent = `${purpleValue.toFixed(2)}x`;
            document.querySelector('.card-value.pink').textContent = `${pinkValue.toFixed(2)}x`;
        }
        
        // ====================================================================
        // 4. LÓGICA DE PROBABILIDADE 10x e 50x (Desativada da UI)
        // ====================================================================
        // Funções mantidas como stubs para compatibilidade, mas não afetam a UI
        function getTimePatternProbability(history) { return 0; }
        function calculateProb10x(history) { return 0; }
        function calculateCustomProb(count, minVelas, maxVelas) { return 0; }
        function calculateProb50x(history) { return 0; }
        function updateProbability(id, percentage) {}

        // ====================================================================
        // 6. FUNÇÕES GERAIS DE DASHBOARD E RENDERIZAÇÃO
        // ====================================================================

        window.toggleSidebar = function() {
            // Função desativada
        }

        function filterVelas(data) {
            const showBlue = document.getElementById('filter-blue').checked;
            const showPurple = document.getElementById('filter-purple').checked;
            const showPink = document.getElementById('filter-pink').checked;

            return data.filter(item => {
                if (item.color === 'blue' && showBlue) return true;
                if (item.color === 'purple' && showPurple) return true;
                if (item.color === 'pink' && showPink) return true;
                return false;
            });
        }

        /**
         * Renderiza TODAS as velas do histórico filtrado.
         */
        function renderGrid(data) {
            multiplierGrid.innerHTML = '';
            
            if (data.length === 0) {
                 multiplierGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: var(--cor-texto-suave);">Não há dados para esta data ou filtro.</div>';
                 return;
            }
            
            data.forEach(item => { 
                const color = item.color;
                
                const cell = document.createElement('div');
                cell.className = `multiplier-cell color-${color} vela-${color}`;
                cell.setAttribute('data-color', color); 

                cell.innerHTML = `
                    <div class="multiplier-value">${item.multiplier.toFixed(2)}x</div>
                    <div class="multiplier-time">${item.time}</div>
                `;
                multiplierGrid.appendChild(cell);
            });
        }
        
        /**
         * FUNÇÃO PRINCIPAL: Aplica todos os filtros e roda todas as lógicas
         */
        window.renderDashboard = function() {
            const selectedDate = dateFilter.value;
            
            // 1. FILTRAGEM POR DATA
            const dataByDate = historyData.filter(item => item.date === selectedDate);

            // 2. CÁLCULO DAS MÉDIAS
            calculateColorAverages(dataByDate);
            
            // 3. CÁLCULO DAS PROBABILIDADES (IGNORADO NA UI)

            // 4. FILTRAGEM POR COR
            const finalData = filterVelas(dataByDate);

            // 5. RENDERIZAÇÃO DA GRADE
            renderGrid(finalData);
        }

        // ====================================================================
        // 7. LISTENER FIREBASE (Ponto de entrada de dados)
        // ====================================================================

        onValue(ref(db, "history/"), (snapshot) => {
          const data = snapshot.val();
          if (!data) {
            historyData = [];
            renderDashboard(); 
            return;
          }
          
          let rawHistory = Object.values(data);
          
          const finalHistory = rawHistory
            .filter(item => item.multiplier && item.time && item.date)
            .map(item => {
                const multiplier = parseFloat(item.multiplier.replace('x', ''));
                return {
                    multiplier: multiplier,
                    time: item.time,
                    date: item.date, 
                    color: getVelaColor(multiplier),
                    minutes: timeToMinutes(item.time)
                };
            })
            // Ordena do mais novo para o mais antigo
            .reverse(); 

          historyData = finalHistory.slice(0, 100000); 
          
          renderDashboard();

          console.log("[FIREBASE] Histórico sincronizado e dashboard atualizado.");
        });
        
        // ====================================================================
        // 8. Inicialização
        // ====================================================================
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const todayDateString = formatDate(today);
            
            dateFilter.setAttribute('max', todayDateString);
            dateFilter.value = todayDateString; 
        });

    </script>
</body>
</html>